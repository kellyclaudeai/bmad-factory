rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function requesterUserDocExists() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }
    
    function requesterWorkspaceId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.workspaceId;
    }
    
    function isWorkspaceMember(workspaceId) {
      return requesterUserDocExists() &&
             requesterWorkspaceId() == workspaceId;
    }
    
    function isWorkspaceOwner(workspaceId) {
      return isWorkspaceMember(workspaceId) &&
             exists(/databases/$(database)/documents/workspaces/$(workspaceId)) &&
             get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.ownerId == request.auth.uid;
    }

    function isChannelCreator(workspaceId, channelId) {
      return isWorkspaceMember(workspaceId) &&
             exists(/databases/$(database)/documents/workspaces/$(workspaceId)/channels/$(channelId)) &&
             get(/databases/$(database)/documents/workspaces/$(workspaceId)/channels/$(channelId)).data.createdBy == request.auth.uid;
    }
    
    function isSameWorkspaceUser(userId) {
      return requesterUserDocExists() &&
             exists(/databases/$(database)/documents/users/$(userId)) &&
             get(/databases/$(database)/documents/users/$(userId)).data.workspaceId == requesterWorkspaceId();
    }
    
    function isDmParticipant(workspaceId, dmId) {
      return isWorkspaceMember(workspaceId) &&
             exists(/databases/$(database)/documents/workspaces/$(workspaceId)/directMessages/$(dmId)) &&
             request.auth.uid in get(/databases/$(database)/documents/workspaces/$(workspaceId)/directMessages/$(dmId)).data.userIds;
    }

    function isValidWorkspaceInvitePayload(inviteId) {
      return request.resource.data.inviteId is string &&
             request.resource.data.inviteId == inviteId &&
             request.resource.data.workspaceId is string &&
             request.resource.data.workspaceId.size() > 0 &&
             request.resource.data.token is string &&
             request.resource.data.token.size() > 0 &&
             request.resource.data.createdBy is string &&
             request.resource.data.createdBy == request.auth.uid &&
             request.resource.data.expiresAt is timestamp &&
             request.resource.data.expiresAt > request.time;
    }

    function isValidUnreadTargetType(targetType) {
      return targetType == "channel" || targetType == "dm";
    }

    function hasValidUnreadCountShape(data, userId) {
      return data.userId is string &&
             data.userId == userId &&
             data.targetId is string &&
             data.targetId.size() > 0 &&
             data.targetType is string &&
             isValidUnreadTargetType(data.targetType) &&
             (data.count is int || data.count is float) &&
             data.count >= 0 &&
             data.lastReadAt is timestamp &&
             data.updatedAt is timestamp;
    }

    function hasValidMessageText(data) {
      return data.text is string &&
             data.text.size() > 0 &&
             data.text.size() <= 4000;
    }
    
    // Workspaces: Users can read/update their own workspace
    match /workspaces/{workspaceId} {
      allow read: if isWorkspaceMember(workspaceId);
      allow create: if isAuthenticated();
      allow update: if isWorkspaceOwner(workspaceId);
      allow delete: if isWorkspaceOwner(workspaceId);
      
      // Channels: All workspace members can read/create
      match /channels/{channelId} {
        allow read: if isWorkspaceMember(workspaceId);
        allow create: if isWorkspaceMember(workspaceId);
        allow update: if isWorkspaceOwner(workspaceId) || 
                        resource.data.createdBy == request.auth.uid;
        allow delete: if (isWorkspaceOwner(workspaceId) || 
                            resource.data.createdBy == request.auth.uid) &&
                          resource.data.name != "general";
        
        // Messages: All workspace members can read/create, author can update/delete
        match /messages/{messageId} {
          allow read: if isWorkspaceMember(workspaceId);
          allow create: if isWorkspaceMember(workspaceId) && 
                          request.resource.data.userId == request.auth.uid &&
                          request.resource.data.workspaceId == workspaceId &&
                          hasValidMessageText(request.resource.data);
          allow update: if resource.data.userId == request.auth.uid;
          allow delete: if resource.data.userId == request.auth.uid ||
                          isWorkspaceOwner(workspaceId) ||
                          isChannelCreator(workspaceId, channelId);
        }
      }
      
      // Direct Messages: Participants only
      match /directMessages/{dmId} {
        allow read: if isWorkspaceMember(workspaceId) &&
                      request.auth.uid in resource.data.userIds;
        allow create: if isWorkspaceMember(workspaceId) && 
                        request.auth.uid in request.resource.data.userIds;
        
        match /messages/{messageId} {
          allow read: if isDmParticipant(workspaceId, dmId);
          allow create: if isDmParticipant(workspaceId, dmId) && 
                          request.resource.data.userId == request.auth.uid &&
                          hasValidMessageText(request.resource.data);
        }
      }
    }
    
    // Users: Users can read only users in their workspace, update only themselves
    match /users/{userId} {
      allow read: if isAuthenticated() &&
                    (userId == request.auth.uid || isSameWorkspaceUser(userId));
      allow create: if isAuthenticated() && userId == request.auth.uid;
      allow update: if userId == request.auth.uid;
      allow delete: if userId == request.auth.uid;
    }

    // Workspace invites: Allows invite generation + public validation for invite links.
    match /workspaceInvites/{inviteId} {
      allow read: if resource.data.expiresAt is timestamp &&
                    resource.data.expiresAt > request.time;
      allow create: if requesterUserDocExists() &&
                      request.resource.data.workspaceId == requesterWorkspaceId() &&
                      isValidWorkspaceInvitePayload(inviteId);
      allow update, delete: if isAuthenticated() &&
                              resource.data.workspaceId is string &&
                              (resource.data.createdBy == request.auth.uid ||
                                isWorkspaceOwner(resource.data.workspaceId));
    }
    
    // Unread counts: Users can only access their own
    match /unreadCounts/{countId} {
      allow read: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() &&
                      hasValidUnreadCountShape(request.resource.data, request.auth.uid) &&
                      countId == request.auth.uid + "_" + request.resource.data.targetId;
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid &&
                      hasValidUnreadCountShape(request.resource.data, request.auth.uid) &&
                      request.resource.data.targetId == resource.data.targetId &&
                      request.resource.data.targetType == resource.data.targetType &&
                      countId == request.auth.uid + "_" + resource.data.targetId;
      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }
  }
}
