rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isWorkspaceMember(workspaceId) {
      return isAuthenticated() && getUserData().workspaceId == workspaceId;
    }
    
    function isWorkspaceOwner(workspaceId) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/workspaces/$(workspaceId)).data.ownerId == request.auth.uid;
    }
    
    // Workspaces: Users can read/update their own workspace
    match /workspaces/{workspaceId} {
      allow read: if isWorkspaceMember(workspaceId);
      allow create: if isAuthenticated();
      allow update: if isWorkspaceOwner(workspaceId);
      allow delete: if isWorkspaceOwner(workspaceId);
      
      // Channels: All workspace members can read/create
      match /channels/{channelId} {
        allow read: if isWorkspaceMember(workspaceId);
        allow create: if isWorkspaceMember(workspaceId);
        allow update, delete: if isWorkspaceOwner(workspaceId) || 
                                  resource.data.createdBy == request.auth.uid;
        
        // Messages: All workspace members can read/create, author can update/delete
        match /messages/{messageId} {
          allow read: if isWorkspaceMember(workspaceId);
          allow create: if isWorkspaceMember(workspaceId) && 
                          request.resource.data.userId == request.auth.uid &&
                          request.resource.data.workspaceId == workspaceId;
          allow update, delete: if resource.data.userId == request.auth.uid;
        }
      }
      
      // Direct Messages: Participants only
      match /directMessages/{dmId} {
        allow read: if isWorkspaceMember(workspaceId) && 
                      request.auth.uid in resource.data.userIds;
        allow create: if isWorkspaceMember(workspaceId) && 
                        request.auth.uid in request.resource.data.userIds;
        
        match /messages/{messageId} {
          allow read: if isWorkspaceMember(workspaceId) && 
                        request.auth.uid in get(/databases/$(database)/documents/workspaces/$(workspaceId)/directMessages/$(dmId)).data.userIds;
          allow create: if isWorkspaceMember(workspaceId) && 
                          request.resource.data.userId == request.auth.uid;
        }
      }
    }
    
    // Users: Users can read all workspace members, update only themselves
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && userId == request.auth.uid;
      allow update: if userId == request.auth.uid;
      allow delete: if userId == request.auth.uid;
    }
    
    // Unread counts: Users can only access their own
    match /unreadCounts/{countId} {
      allow read, write: if isAuthenticated() && 
                           resource.data.userId == request.auth.uid;
    }
  }
}
