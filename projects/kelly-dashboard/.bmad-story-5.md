# Story 5: Factory View - Health Dashboard

## Objective
Create a health metrics API endpoint and dashboard component that displays 6 key factory health indicators with color-coded status badges.

## Files to Create

### 1. app/api/health-metrics/route.ts
Create a Next.js API route that calculates 6 health metrics:

**Metrics to Calculate:**
1. **Session Failures/Retries**
   - Count sessions with status 'failed' or error field
   - Threshold: Green (0), Amber (1-3), Red (4+)

2. **Protocol Violations**
   - Scan for violation keywords (stub for now - return 0)
   - Threshold: Green (0), Amber (1-2), Red (3+)

3. **Queue Depth + Throughput**
   - queueDepth = queued projects count
   - throughput = active sessions count
   - Threshold: Green (<5), Amber (5-10), Red (11+)

4. **Cost/Token Burn**
   - Sum tokens across all sessions * $0.015/1K
   - Threshold: Green (<$50), Amber ($50-$100), Red ($100+)

5. **Blocked Projects**
   - Count projects with lastActivity > 4 hours ago AND status 'active'
   - Threshold: Green (0), Amber (1), Red (2+)

6. **Bottleneck Timestamps**
   - Find slowest story in active projects (longest duration)
   - Threshold: Green (<30min), Amber (30-60min), Red (60+)

**Response Format:**
```typescript
type HealthMetric = {
  label: string
  value: string
  status: 'healthy' | 'warning' | 'critical'
}
```

**Data Sources:**
- GET /api/factory-state (for queue depth)
- GET /api/sessions (for failures, throughput, tokens)
- GET /api/project-state?id={id} (for blocked projects, bottlenecks)

**Caching:** Use Next.js revalidate: 10 seconds

### 2. components/factory-view/health-dashboard.tsx
Create a Client Component that displays the 6 health metrics.

**Features:**
- Use SWR for auto-refresh every 10 seconds
- Display 6 metric cards in 3x2 grid (responsive: 2x3 on tablet, 1x6 on mobile)
- Each card shows: label, value, status badge
- Loading state: skeleton cards
- Error state: "Unable to load health metrics"

**Styling:**
- Terminal aesthetic (dark bg, green/amber/red accents)
- Cards use shadcn/ui Card component
- Badges use TerminalBadge component (to be created)
- Font: Geist Mono for labels/values

### 3. components/shared/terminal-badge.tsx
Create a reusable badge component with status variants.

**Props:**
```typescript
type TerminalBadgeProps = {
  children: React.ReactNode
  status: 'healthy' | 'warning' | 'critical'
  className?: string
}
```

**Styling:**
- healthy: green background (#00ff88 with 10% opacity), green text, green border
- warning: amber background (#ffaa00 with 10% opacity), amber text, amber border
- critical: red background (#ff4444 with 10% opacity), red text, red border
- Use Geist Mono font
- Small padding, rounded corners

## Technical Requirements
- TypeScript strict mode
- Use shadcn/ui components where applicable
- Use SWR for client-side data fetching
- Follow Next.js 15 App Router conventions
- Terminal color palette: green (#00ff88), amber (#ffaa00), red (#ff4444)

## Acceptance Criteria
✅ Health dashboard shows 6 metrics
✅ Color coding based on thresholds (green/amber/red)
✅ Auto-refresh every 10s
✅ Loading state (skeleton cards)
✅ Terminal aesthetic styling

## Notes
- This is Story 5 of 12 in the Kelly Dashboard upgrade
- Stories 1-2 are complete (scaffold + API routes exist)
- Terminal design system colors already configured in Tailwind
