# Memory Log ‚Äî 2026-02-18

## Major Events

### Research Lead Sessions (Complete)
- **Session 1 (Prepwise)**: Shopping list budget tracker, scored 46/50. Output: `projects/ideas/smart-receipt-budgeting-tracker-2026-02-18-1656/intake.md`
- **Session 2 (ClaimDone)**: Warranty claim concierge, scored 43/50. Output: `projects/ideas/warranty-receipt-tracker-2026-02-18-1733/intake.md`
- **Session 3 (PULSE)**: Hyperlocal event discovery, scored 40/50. Output: `projects/ideas/hyper-local-event-discovery-2026-02-18-1824/intake.md`
- **Session 4**: Running, using new workspace (`workspaces/research-lead/`)

### NoteLite Implementation Progress
- 16+ stories complete (~30%+), stalled due to zombie subagent bug
- Stories completed today: 3.5 (Slash Command), 4.6 (Page Navigation), 8.3 (Firestore Indexes)

### Directory Restructure
- Created `projects/ideas/` for Research Lead outputs
- Registry updated to v1.1 with `researchDir` field
- Updated 4 core docs: project-registry-workflow, research-lead-flow, project-lead-flow, kelly-router-flow

### Gateway SIGTERM Incident (19:07 CST)
- External SIGTERM killed 9 running agents mid-execution
- openclaw.json was stripped to only `research-lead` at 19:16
- Restored config from backup at 19:23
- Added all 16 agents back at 19:30

## üî¨ ZOMBIE SUBAGENT BUG ‚Äî ROOT CAUSE FOUND (20:47 CST)

### Symptom
- NoteLite PL session spawns subagents, ~85% become zombies (0 tokens, never process)
- Fresh PL session (no heartbeat) spawns 4/4 successfully in parallel

### Root Cause (CONFIRMED via error logs)
**PL heartbeat on `nested` lane (concurrency 1) blocks subagent announce-back.**

The announce-back mechanism:
1. Subagent completes work (~5 seconds)
2. Subagent tries to announce result back to parent PL session
3. Announce must go through PL's command queue on `nested` lane (concurrency 1)
4. If PL is busy (heartbeat turn), announce waits in queue
5. After 60s timeout, announce fails ‚Üí result lost
6. PL's next heartbeat sees 0 active subagents ‚Üí re-spawns ‚Üí cycle repeats

### Evidence
```
02:47:26 UTC ‚Äî Subagent announce failed: Error: gateway timeout after 60000ms (x4)
02:47:26 UTC ‚Äî announce queue drain failed for agent:project-lead:project-notelite
```
Timeline: PL spawned 4 agents at 20:46:26, all 4 announce-backs failed at 20:47:26 (exactly 60s later = heartbeat interval).

### OpenClaw Lane Architecture (from source code)
- 4 lanes: `main` (24), `cron` (1), `subagent` (96), `nested` (unconfigured ‚Üí defaults to 1)
- `sessions_spawn` hardcodes `lane: AGENT_LANE_SUBAGENT` (concurrency 96) ‚Äî works fine
- `gateway call agent` defaults `lane: AGENT_LANE_NESTED` (concurrency 1) ‚Äî bottleneck
- Heartbeat fires PL turns on nested lane, blocking announce-back delivery
- Key source files: `reply-DptDUVRg.js` (line ~49916), `gateway-cli-DZge3TdL.js` (line ~10072)

### Fix Applied (20:49 CST)
- Removed PL heartbeat from openclaw.json
- PL now inherits default heartbeat (`target: none` = disabled)
- Gateway restarted via SIGUSR1

### Test In Progress (20:55 CST)
- Fresh PL-v2 session (`agent:project-lead:project-notelite-v2`) spawned
- 2 Amelias spawned: story 3.8 (arrow nav fix) + story 2.1 (auth completion)
- Monitoring for announce-back success (first real test without heartbeat)

## Lessons Learned
1. **OpenClaw `nested` lane concurrency 1 is a critical bottleneck** ‚Äî any agent using `gateway call agent` shares this lane
2. **Heartbeat + subagent spawning = deadlock** ‚Äî heartbeat occupies the lane, preventing subagent results from being delivered
3. **Fresh sessions work, bloated sessions don't** ‚Äî not because of context size, but because heartbeat is only active on sessions that have been running long enough to trigger it
4. **Error logs are the smoking gun** ‚Äî `gateway.err.log` showed "Subagent announce failed" which immediately confirmed the hypothesis

## State File Cleanup (21:02 CST)

**BREAKING CHANGE:** Removed `state/kelly.json` entirely.

**Problem:** Agent-specific state files clutter compaction. Different agents had different state structures, making the compaction summary inconsistent and noisy.

**Solution:** Eliminate kelly.json, move responsibilities:
- **surfacedQA tracking** ‚Üí `project-registry.json` (add `surfacedForQA: boolean` field per project)
- **Heartbeat check timestamps** ‚Üí ephemeral (session memory, no persistence needed)
- **Operational notes/pending/waiting** ‚Üí `memory/YYYY-MM-DD.md` (daily logs)

**New state structure (all agents):**
- Kelly Router: `memory/YYYY-MM-DD.md` (daily log)
- Project Lead: `projects/project-registry.json` (project entry) + `memory/YYYY-MM-DD.md`
- Research Lead: `projects/project-registry.json` (discovery entry) + `memory/YYYY-MM-DD.md`

**Rationale:** Compaction now 10x cleaner‚Äîeveryone uses the same simple structure. QA surfacing state belongs with the project (in registry), not in Kelly's operational state. If Kelly restarts, re-checking projects is harmless.

**Updated:**
- Added `surfacedForQA` field to all 4 existing projects (Prepwise, ClaimDone, Ripple, Triage)
- Updated 5 core docs: project-registry-workflow, kelly-router-flow, project-lead-flow, AGENTS.md, HEARTBEAT.md
- Deleted `state/kelly.json`

Commit: 6ae2fe5

## Compaction Prompt Unified (21:08 CST)

**Created:** `docs/core/state-management.md` ‚Äî Canonical state management architecture doc.

**New unified compaction prompt (agent-agnostic):**
```
Pre-compaction state flush. Update the state files you own:

1. projects/project-registry.json (if you created/modified a project entry)
2. memory/YYYY-MM-DD.md (daily log - capture recent decisions, events, waiting-on items)

After updating, reply NO_REPLY.
```

**Why:** All agents use same state structure now (registry + daily memory). No need for agent-specific divisions in compaction prompt.

**Marked as superseded:**
- `docs/proposals/compaction-state-refresh.md`
- `docs/proposals/state-files-minimal.md`
- `docs/proposals/state-migration-complete.md`
- `docs/proposals/state-schema-design.md`

These proposals referenced kelly.json and agent-specific state files that no longer exist.

## Session-Closer Skill Fixed (21:13 CST)

**Problem:** `session-closer` was calling `openclaw gateway restart` which **fully stops and starts the Gateway service**, breaking all active connections every time a session was closed.

**Root cause:** `subprocess.run(["openclaw", "gateway", "restart"])` triggers a full service restart via launchd, not a graceful reload.

**Fix:** Removed gateway restart entirely. The Gateway reads `sessions.json` dynamically - changes are reflected within seconds via dashboard auto-refresh. No restart needed.

**Changes:**
- `scripts/close_project_lead_session.py` ‚Äî Removed `openclaw gateway restart` call
- `SKILL.md` ‚Äî Updated docs to reflect no-restart behavior
- Removed `--restart-gateway` and `--no-restart-gateway` args (obsolete)

**Result:** Closing sessions no longer breaks the gateway. Dashboard updates automatically.

Commit: ff19cec

## Research Lead Sessions 5 & 6 Started (21:13 CST)

**Session 5:** `agent:research-lead:5`  
**Session 6:** `agent:research-lead:6`  
**Platform:** iOS mobile app (Swift, SwiftUI, Firebase)  
**Business Model:** B2C consumer  
**Blocklist:** Event discovery, warranty tracking, receipt/budget tracking, screenshot management, meal planning, plant care

Both running autonomous workflows in parallel (~40-50 min expected each).

## Subagent Announce-Back Fix CONFIRMED (20:55‚Äì21:00 CST)

After disabling PL heartbeat:
- **Amelia (Story 3.8)**: Completed 5 fixes, committed bce7040, announce-back SUCCESS at 20:56:52 UTC
- **Amelia (Story 2.1)**: Verified Firebase Auth, marked DONE, announce-back SUCCESS
- PL received both, acknowledged, analyzing sprint status
- **Final batch test**: 4/4 agents completed, 100% success rate, zero zombies

## Stale Session Cleanup (21:05 CST)

- Notelite v2 session (`agent:project-lead:project-notelite-v2`) already archived (`.deleted` suffix)
- 19 total active sessions visible ‚Äî need cleanup of old subagent/research-lead/matrix sessions
- Session-closer skill available but not yet run for bulk cleanup

## CRITICAL FINDING: BMM Agent Workspaces NOT Wired Up (21:12 CST)

**Problem:** All BMM/CIS/TEA agents have workspace files at `clawd/workspaces/bmad-bmm-*` (AGENTS.md, SOUL.md, TOOLS.md) but agents.list entries have `workspace: NONE`. When PL spawns Amelia, she runs WITHOUT her persona instructions.

**Files exist for:**
- bmad-bmm-amelia, bmad-bmm-bob, bmad-bmm-john, bmad-bmm-sally, bmad-bmm-winston
- bmad-bmm-murat, bmad-qf-barry

**Agent IDs in config vs workspace dir names ‚Äî MISMATCH:**
- Config: `bmad-bmm-amelia` ‚Üí Workspace dir: `bmad-bmm-amelia` ‚úÖ
- Config: `bmad-tea-murat` ‚Üí Workspace dir: `bmad-bmm-murat` ‚ö†Ô∏è (naming inconsistency)
- Config: `bmad-bmm-barry` ‚Üí Workspace dir: `bmad-qf-barry` ‚ö†Ô∏è (naming inconsistency)
- Config: `bmad-cis-carson/victor/maya/quinn` ‚Üí NO workspace dirs exist ‚ùå
- Config: `bmad-bmm-mary` ‚Üí NO workspace dir exists ‚ùå

**Impact:** Every subagent spawned by PL has been running without its persona, potentially explaining quality issues or inconsistent behavior.

**Next step:** Wire workspace paths into agents.list config entries. Need to resolve naming mismatches and create missing workspaces for CIS agents (carson, victor, maya, quinn) and mary.

## BMM Agent Visibility Discussion (21:12 CST)

- User wants only 4 top-level agents: main, kelly-improver, research-lead, project-lead
- BMM agents MUST remain in agents.list (PL's allowAgents needs them for spawn resolution)
- OpenClaw schema has NO hidden/subagentOnly flag
- No config-level solution exists ‚Äî would need UI filtering or OpenClaw feature request

## PL Subagent Failure Monitoring ‚Äî Event-Driven (21:12 CST)

- PL does NOT need heartbeat for monitoring ‚Äî `sessions_spawn` has built-in failure handling
- Subagent completes ‚Üí auto announce-back ‚úÖ
- Subagent times out ‚Üí PL gets timeout error ‚úÖ
- Subagent crashes ‚Üí PL gets error announce ‚úÖ
- With heartbeat disabled, announce delivery path is clear
- If PL is mid-turn, announces queue and deliver when turn finishes

## Key Config State (end of day)
- PL heartbeat: DISABLED
- 16 agents in openclaw.json: 4 orchestrators + 7 BMM/TEA + 5 Research
- Research Lead allowlist: mary, carson, victor, maya, quinn
- Project Lead allowlist: john, sally, winston, bob, amelia, barry, murat
- Dashboard: localhost:3000 (15min session window, 120min research window)
- **State files:** project-registry.json + memory/YYYY-MM-DD.md (no more kelly.json)
- **BMM workspaces:** FIXED ‚Äî removed 12 BMM agents from agents.list, created fallback workspace dirs at ~/.openclaw/workspace-{agentId}/

## BMM Agent Config Cleanup (21:20 CST)

**Problem:** 12 BMM/CIS/TEA agents cluttering TUI `/agents` command. No `hidden` flag in schema.

**Solution found via source code analysis:**
- `sessions_spawn` permission check only looks at parent's `allowAgents` ‚Äî does NOT require target in `agents.list`
- Workspace resolution fallback: if agent not in agents.list ‚Üí `~/.openclaw/workspace-{agentId}/`
- Model fallback: uses `cfg.agents.defaults.subagents.model`

**Changes made:**
1. Removed 12 agents from agents.list (was 16, now 4: main, research-lead, project-lead, kelly-improver)
2. Created 12 fallback workspace dirs at `~/.openclaw/workspace-{agentId}/` with SOUL.md + AGENTS.md + TOOLS.md
3. PL/RL `allowAgents` unchanged ‚Äî still reference all 12 agent IDs
4. Created NEW workspace files for 5 RL subagents (mary, carson, victor, maya, quinn) that had none before
5. Fixed name mismatches: bmad-bmm-murat ‚Üí bmad-tea-murat, bmad-qf-barry ‚Üí bmad-bmm-barry

**Result:** TUI `/agents` shows only 4 agents. PL/RL can still spawn all 12 subagents with full persona files.

**Also confirmed:** OpenClaw has built-in subagent failure handling:
- `registerSubagentRun()` ‚Üí `waitForSubagentCompletion()` ‚Üí `agent.wait` with 600s timeout
- If subagent dies silently ‚Üí timeout ‚Üí failure announced back to parent
- `SUBAGENT_ANNOUNCE_TIMEOUT_MS` = 120s for announce delivery
- Persisted registry survives gateway restarts (`resumeSubagentRun()` picks up orphans)

## NoteLite Project Lead Status Check (21:24 CST)

**User request:** Check on NoteLite Project Lead

**Finding:** PL session idle, waiting for direction
- **No ready-for-dev stories** (sprint-status shows 0)
- **41/45 stories done** (91% complete)
- **2 in-progress stories with blocking issues:**
  - Story 2.1: Firebase Auth - needs rework
  - Story 3.8: Arrow navigation - CRITICAL build failure + HIGH missing feature
- **2 backlog stories:**
  - Story 8.1: Code splitting (dependencies met, could start)
  - Story 10.1: Keyboard navigation (blocked on 3.8, 4.6, 5.3)

**User mentioned "7.5 active subagent"** but:
- Story 7.5 is marked DONE (code review approved 2026-02-18)
- No active subagent found in sessions list
- Possible stale dashboard data or zombie session

**PL last action:** Asked user for guidance on what to do next (no ready-for-dev stories to spawn)

**Waiting on:** User clarification about 7.5 subagent reference

## Research Lead Sessions 5 & 6 - Phase 5 Status (21:28 CST)

**Both sessions in Phase 5: Competitive Deep-Dive (Mary analyzing)**

**Session 5 - Social Anxiety App:**
- Selected solution: "Oops" (social failure journal with personalized recovery prompts)
- Mary spawned ~5 min ago for competitive analysis
- Expected completion: 3-7 min remaining

**Session 6 - Gift Tracking App:**
- Selected solution: "Sift" (lock screen widget voice assistant for gift ideas)
- Mary spawned ~5 min ago for competitive analysis  
- Expected completion: 3-7 min remaining

**Next:** Once Mary completes deep-dive:
- IF GO ‚Üí Phase 6 (Intake Creation) ‚Üí `projects-queue/` output
- IF NO-GO ‚Üí Document reasoning, abort

**Timeline:** ~40-50 min total per session for full autonomous workflow

## Research Lead Sessions Complete (21:33-21:36 CST)

**Session 5 (Bounce - Social Anxiety App):**
- ‚úÖ Phase 6 Complete - Full autonomous workflow (discovery ‚Üí selection ‚Üí deep-dive ‚Üí naming ‚Üí finalization)
- Product: "Bounce" - Social failure journal that celebrates awkwardness, detects personal anxiety patterns
- Score: 42/50
- Discovery approach: Direct demand signals (r/socialanxiety, 227K members)
- Novel positioning: First consumer app to celebrate social failures as learning data
- Output: `projects/ideas/social-conversation-coach-2026-02-18-2113/intake.md`
- Registered in project-registry.json (state: discovery)
- ‚úÖ Announced to operator via sessions_send

**Session 6 (Sift - Gift Tracking App):**
- üîÑ Phase 6 In Progress - Carson generating creative names
- Product: Lock screen widget voice assistant for gift idea capture
- Mary Phase 5: GO recommendation (83/100 score)
- Zero competitors with lock screen + voice combo
- ETA: ~3-5 minutes to completion

**Agent-to-agent announce validation:**
- ‚úÖ Research Lead ‚Üí Kelly announce working correctly
- Validates earlier zombie bug fix (heartbeat disabled on PL)
- Event-driven architecture functioning properly
- No polling needed, clean announce-backs on completion

**Documentation gap identified:**
- User asked about "prd" file format and executive summary
- Both `docs/core/research-lead-flow.md` and `~/.openclaw/workspace-research-lead/AGENTS.md` still reference old "intake.md" format
- Need clarification on when/where new format was defined
- Awaiting user guidance on correct output format

**Waiting on:**
- Research Lead Session 6 completion (~3-5 min)
- User clarification on prd/executive summary format change
