# 2026-02-18 Daily Notes

[Previous content preserved above...]

---

## CLI-First Policy Enforcement (16:29-16:36 CST)

### Problem Identified
**Operator flagged:** NoteLite story 1.2 (Firebase setup) appeared to use excessive browser automation based on session logs showing screenshots and browser activity.

**User question:** "Are we sure it didn't use browser automation a lot? I saw a couple screenshots being taken and stuff though."

### Investigation
**Story 1.2 actual breakdown** (from completion notes):
- ‚úÖ CLI-based (80%): gcloud projects create, firebase CLI, npm install, API enablement
- üåê Browser-based (20%): Firestore database creation (region selection), Firebase Auth Google provider (consent screen)
- **Amelia's reasoning:** `firebase-cli` skill explicitly says Auth provider setup can require browser when interactive

**Log volume skew:** Browser automation generates verbose output (CDP messages, snapshots, element trees) while CLI commands are one-liners ‚Üí created impression of "mostly browser" when effort was inverted

### Root Cause Analysis
**User insight:** "I want to solve it upstream so future problems avoid using the UI/Browser as much as possible. The problem was in the BMAD planning it looks like. It's assuming the human operator will be working with it, not an automated factory."

**Key finding:** BMAD workflows are designed for interactive human collaboration ("Navigate to Firebase Console ‚Üí Click Add Project"). Winston and Bob were writing planning artifacts for humans, but **Amelia executes them autonomously**.

**Mismatch chain:**
1. BMAD workflows ‚Üí interactive/collaborative by design
2. Winston runs workflow ‚Üí outputs architecture.md with "Navigate to console"  
3. Bob reads architecture ‚Üí writes story tasks as "Click X, fill Y"
4. Amelia reads story ‚Üí uses browser automation (follows instructions literally)

### Solution: Upstream Fix via Workspace Wrappers

**Operator clarification:** "I'd rather you dont touch BMAD workflow templates and instead we could add wrappers around things like Winston/Bob? Not totally sure."

**Approach taken:** Workspace config wrappers (NOT BMAD templates)

**Files updated:**

1. **`docs/factory-principles.md`** (NEW)
   - Created comprehensive factory principles document
   - **Principle #1:** CLI-first policy (browser as absolute last resort)
   - Defines when CLI vs browser is appropriate
   - Applies to ALL agents (planning, implementation, testing)

2. **`workspaces/bmad-bmm-winston/AGENTS.md`**
   - Added "üè≠ FACTORY AUTOMATION CONTEXT" section
   - Explicit: "Your output will be executed by AGENTS, not humans"
   - Setup procedures ‚Üí CLI commands (not "Navigate to console")
   - Includes CLI examples (Firebase, Vercel, GitHub)
   - CLI-based setup section in architecture template guidance

3. **`workspaces/bmad-bmm-bob/AGENTS.md`**
   - Added "üè≠ FACTORY AUTOMATION CONTEXT" section
   - Story tasks ‚Üí CLI commands (not browser instructions)
   - CLI-first task writing examples (GOOD vs BAD)
   - Clarifies: Amelia/Barry will execute these literally

4. **`workspaces/bmad-bmm-amelia/TOOLS.md`**
   - Added "## CLI-First Policy (CRITICAL)" section
   - Explicit guidance: Default to CLI, browser only as last resort
   - Firebase CLI examples (gcloud + firebase commands)
   - **Override authority:** "If story says browser but CLI exists, OVERRIDE the story"

5. **`docs/factory-overview.md`**
   - Updated to reference factory-principles.md
   - Added link in header

**What was NOT touched:**
- ‚ùå `projects/*/._bmad/bmm/workflows/*.md` ‚Äî BMAD templates left alone
- ‚ùå Any `_bmad/` directory structures
- ‚úÖ Only workspace AGENTS.md/TOOLS.md files (wrapper approach)

### Impact Assessment

**Before this fix:**
- Winston architecture.md: "Create Firebase project in console" ‚Üí browser automation
- Story 1.2 tasks: List of UI click instructions ‚Üí slow, verbose logs

**After this fix:**
- Winston architecture.md: "Run `gcloud projects create && firebase projects:addfirebase`" ‚Üí CLI
- Story 1.2 tasks: Executable bash commands ‚Üí fast, deterministic

**Current NoteLite project:** Story 1.2 is already complete and accepted (80% CLI, 20% browser for genuinely interactive steps). No action needed.

**Next projects:** Planning artifacts will be CLI-first by default. Browser only when NO CLI exists.

### Key Decisions

1. **Story 1.2 accepted as-is** ‚Äî Working, committed, followed existing guidance
2. **Wrapper approach confirmed** ‚Äî Workspace configs, not BMAD templates
3. **Factory-wide principles codified** ‚Äî CLI-first is now factory principle #1
4. **Agent context added** ‚Äî Winston/Bob know they're writing for agent execution

### Commits

- `eb94fb1` ‚Äî docs: Add factory-wide CLI-first policy (factory-principles.md, Amelia TOOLS.md, Winston/Bob AGENTS.md)
- `2cce900` ‚Äî docs: Add Factory Automation Context to Winston and Bob
- `0008d77` ‚Äî docs: Log CLI-first upstream fix in changelog

### Lessons Learned

**Design pattern validated:** Workspace wrappers can adapt BMAD workflows to factory context without modifying BMAD itself. This allows:
- BMAD workflows to remain human-friendly for manual use
- Factory agents to receive automation-specific guidance
- Separation of concerns (BMAD = workflow, workspace = execution context)

**Log volume ‚â† actual work:** Verbose tool output (browser logs) can misrepresent where effort is spent. Check completion notes for ground truth.

**Upstream > downstream:** Fixing planning artifacts (architecture, stories) prevents downstream patching in implementation. Better to write CLI-based stories than have Amelia override them.

---

_End of 2026-02-18 daily notes. Total session time: ~6 hours (10:00-16:36 CST)._

---

## CLI-First Policy Enforcement (16:29-16:36 CST)

### Problem Identified
**Operator flagged:** NoteLite story 1.2 (Firebase setup) appeared to use excessive browser automation based on session logs showing screenshots and browser activity.

**User question:** "Are we sure it didn't use browser automation a lot? I saw a couple screenshots being taken and stuff though."

### Investigation
**Story 1.2 actual breakdown** (from completion notes):
- ‚úÖ CLI-based (80%): gcloud projects create, firebase CLI, npm install, API enablement
- üåê Browser-based (20%): Firestore database creation (region selection), Firebase Auth Google provider (consent screen)
- **Amelia's reasoning:** `firebase-cli` skill explicitly says Auth provider setup can require browser when interactive

**Log volume skew:** Browser automation generates verbose output (CDP messages, snapshots, element trees) while CLI commands are one-liners ‚Üí created impression of "mostly browser" when effort was inverted

### Root Cause Analysis
**User insight:** "I want to solve it upstream so future problems avoid using the UI/Browser as much as possible. The problem was in the BMAD planning it looks like. It's assuming the human operator will be working with it, not an automated factory."

**Key finding:** BMAD workflows are designed for interactive human collaboration ("Navigate to Firebase Console ‚Üí Click Add Project"). Winston and Bob were writing planning artifacts for humans, but **Amelia executes them autonomously**.

**Mismatch chain:**
1. BMAD workflows ‚Üí interactive/collaborative by design
2. Winston runs workflow ‚Üí outputs architecture.md with "Navigate to console"  
3. Bob reads architecture ‚Üí writes story tasks as "Click X, fill Y"
4. Amelia reads story ‚Üí uses browser automation (follows instructions literally)

### Solution: Upstream Fix via Workspace Wrappers

**Operator clarification:** "I'd rather you dont touch BMAD workflow templates and instead we could add wrappers around things like Winston/Bob? Not totally sure."

**Approach taken:** Workspace config wrappers (NOT BMAD templates)

**Files updated:**

1. **`docs/factory-principles.md`** (NEW)
   - Created comprehensive factory principles document
   - **Principle #1:** CLI-first policy (browser as absolute last resort)
   - Defines when CLI vs browser is appropriate
   - Applies to ALL agents (planning, implementation, testing)

2. **`workspaces/bmad-bmm-winston/AGENTS.md`**
   - Added "üè≠ FACTORY AUTOMATION CONTEXT" section
   - Explicit: "Your output will be executed by AGENTS, not humans"
   - Setup procedures ‚Üí CLI commands (not "Navigate to console")
   - Includes CLI examples (Firebase, Vercel, GitHub)

3. **`workspaces/bmad-bmm-bob/AGENTS.md`**
   - Added "üè≠ FACTORY AUTOMATION CONTEXT" section
   - Story tasks ‚Üí CLI commands (not browser instructions)
   - CLI-first task writing examples (GOOD vs BAD)

4. **`workspaces/bmad-bmm-amelia/TOOLS.md`**
   - Added "## CLI-First Policy (CRITICAL)" section
   - Firebase CLI examples, override authority

5. **`docs/factory-overview.md`**
   - Updated to reference factory-principles.md

**What was NOT touched:**
- ‚ùå BMAD workflow templates (`_bmad/` directories)
- ‚úÖ Only workspace wrappers (AGENTS.md/TOOLS.md files)

### Impact

**Before:** Architecture docs with browser instructions ‚Üí slow implementation
**After:** Architecture docs with CLI commands ‚Üí fast, deterministic

**Story 1.2:** Accepted as-is (80% CLI already, followed existing guidance)
**Future projects:** Planning artifacts will be CLI-first by default

### Commits

- `eb94fb1` ‚Äî docs: Add factory-wide CLI-first policy
- `2cce900` ‚Äî docs: Add Factory Automation Context to Winston and Bob
- `0008d77` ‚Äî docs: Log CLI-first upstream fix in changelog

### Lessons Learned

1. **Workspace wrappers work** ‚Äî Can adapt BMAD workflows without modifying templates
2. **Log volume ‚â† actual work** ‚Äî Browser logs are verbose; check completion notes
3. **Upstream > downstream** ‚Äî Fix planning artifacts, not implementation patches

---

_End of 2026-02-18 daily notes._
## CLI-First Policy Enforcement (16:29-16:38 CST)

### Problem Identified
**Operator flagged:** NoteLite story 1.2 (Firebase setup) appeared to use excessive browser automation based on session logs.

**Investigation:** Story 1.2 was 80% CLI, 20% browser (Firestore region, Auth consent screen). Log volume skew made it appear "mostly browser" when effort was inverted.

### Root Cause
**User insight:** "I want to solve it upstream... The problem was in the BMAD planning. It's assuming the human operator will be working with it, not an automated factory."

**Key finding:** BMAD workflows are designed for interactive human collaboration. Winston/Bob were writing planning artifacts for humans, but agents execute them autonomously.

### Solution: Minimal Upstream Guidance

**Operator request:** "I dont love having factory-principles.md. Let's remove that... What's the lightest way to say 'only use the browser if there is 0 possible alternative'"

**Approach:** Added minimal CLI-first guidance to the right places:

1. **`docs/core/project-lead-flow.md`** ‚Äî CLI-First Policy section (2 sentences)
2. **`workspaces/bmad-bmm-winston/AGENTS.md`** ‚Äî "Write CLI commands (not browser steps). Browser only if no CLI exists." (3 lines)
3. **`workspaces/bmad-bmm-bob/AGENTS.md`** ‚Äî Same, for story tasks (3 lines)
4. **`workspaces/bmad-bmm-amelia/TOOLS.md`** ‚Äî "Use CLI tools. Browser only if no CLI exists." (condensed)
5. **`workspaces/bmad-qf-barry/AGENTS.md`** ‚Äî Same as Amelia (2 lines)

**What was removed:**
- ‚ùå `docs/factory-principles.md` (too heavyweight)

**Lightest rule:** "CLI-first. Browser only if no CLI exists."

### Impact

**Before:** Architecture docs with browser instructions ‚Üí slow implementation
**After:** Architecture docs with CLI commands ‚Üí fast, deterministic

**Story 1.2:** Accepted as-is (80% CLI already, followed existing guidance)
**Future projects:** Planning artifacts will be CLI-first by default

### Commits

- `68932f0` ‚Äî refactor: Simplify CLI-first guidance (remove factory-principles.md)

### Lessons Learned

1. **Less is more** ‚Äî Minimal guidance beats heavyweight documentation
2. **Right place matters** ‚Äî Put guidance where it's actually used (agent AGENTS.md files)
3. **Workspace wrappers work** ‚Äî Can adapt BMAD workflows without modifying templates

---

_End of 2026-02-18 daily notes._

---

## Research Lead Tool Policy Fix (16:44-16:47 CST)

### Problem Identified
**Operator reported:** Mary (Research Lead sub-agent) hitting billing errors during web searches. Session transcript showed multiple successful searches, then sudden API billing failures.

**Error message:** Brave API key out of credits / insufficient balance

### Root Cause Analysis

**Why Mary used Brave API:**
- Mary needed to run web searches for Phase 1 problem discovery
- Two search options available:
  1. `web_search` tool (Brave API) ‚Äî direct tool call, easy
  2. `web-search` skill (SearXNG Docker) ‚Äî requires `exec` tool ‚Üí run shell command, harder

**The problem:**
- Research Lead agent had NO `tools` policy defined
- Mary inherited default tool profile (includes `web_search`)
- LLMs prefer built-in tools over shell commands ‚Üí Mary picked Brave API
- Brave API key exhausted ‚Üí billing errors blocked workflow

**Documentation mismatch:**
- `TOOLS.md` correctly says "Use web-search skill (SearXNG), NOT web_search tool"
- `AGENTS.md` correctly shows skill usage examples
- But tool policy didn't enforce it ‚Üí instructions ignored

### Solution: Tool Policy Enforcement

**Fix:** Added `tools.deny: ["web_search"]` to research-lead agent config

**Implementation:**
```bash
# Via config.patch (atomic config update + restart)
{
  "agents": {
    "list": [
      {
        "id": "research-lead",
        "tools": {
          "deny": ["web_search"]
        }
      }
    ]
  }
}
```

**Effect:**
- Blocks `web_search` tool for research-lead agent and ALL sub-agents (Mary, CIS personas)
- Forces web searches to use `/Users/austenallred/clawd/skills/web-search/bin/search` via `exec`
- SearXNG Docker (localhost:8888) ‚Äî no rate limits, no API costs
- Gateway restarted automatically via SIGUSR1

### Impact

**Before:** Mary could call `web_search("query")` directly ‚Üí Brave API billing errors
**After:** Mary must run `exec("search query")` ‚Üí SearXNG (local, unlimited)

**Why this is better:**
1. No API costs (SearXNG is free)
2. No rate limits (localhost)
3. Aggregates multiple search engines (Google, Bing, DuckDuckGo)
4. Built specifically for high-volume research

### Design Pattern

**Lesson:** Documentation (TOOLS.md, AGENTS.md) is guidance, not enforcement. For critical constraints:
1. Use tool policies (`tools.deny`) to block wrong paths
2. Force agents to use the correct approach
3. Make the right path the only path

**Similar to:** CLI-first policy earlier today ‚Äî guidance + enforcement

### Next Steps

- [ ] Test new Research Lead session ‚Äî verify Mary uses SearXNG
- [ ] Consider updating `docs/core/research-lead-flow.md` to clarify Mary uses **web-search skill** (not web_search tool)

---

_Session continues..._
