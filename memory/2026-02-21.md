# Memory - 2026-02-21

## Session Summary (00:00–03:29 CST)

Long factory architecture + QA session. Major themes: test fraud patterns, Supabase localhost redirect bugs, factory doc hardening, lifecycle tracking, Stripe skill overhaul.

---

## Supabase Localhost Redirect Bug (all 4 projects)

- **Root cause:** `site_url` and `uri_allow_list` had localhost entries in Supabase Auth config
- **Fixed directly via Management API:**
  - SentinelHire: `site_url` was `http://localhost:3000` → fixed to `https://sentinel-hire.vercel.app`
  - ReelRolla: `uri_allow_list` had `localhost:3000` → removed
  - Distill PL also fixed its own: `site_url` + `NEXT_PUBLIC_APP_URL` updated
  - Masterpiece: N/A (NextAuth, not Supabase)
- **Factory docs updated:**
  - `shared-factory-rules.md` — Auth & OAuth section added
  - `project-lead-flow.md` — Gate 5: OAuth/Auth Redirect URL Audit added to pre-deploy checklist
  - `Murat AGENTS.md` — OAuth redirect assertion test mandatory

## Test Fraud Patterns Caught on Distill (third variation)

Three patterns caught on Distill tonight:
1. `test.skip(!hasCredentials)` — entire auth suite skipped silently, 38/38 "passing" with zero auth flows tested
2. URL-only assertions — `not.toHaveURL(/login/)` passes even when page is stuck loading
3. Missing `DATABASE_URL` — Drizzle threw on every page load, never caught by tests

**Factory rules updated:**
- `Murat AGENTS.md` — Zero Skips Rule: `test.skip` banned except story-AC documented rationale
- `Murat Validate checklist` — checks for conditional skips (FAKE → auto-REJECT), URL-only assertions (WEAK), missing console error listeners
- `shared-factory-rules.md` — Zero Skips Rule + correct throw pattern documented
- All committed to dev branch

## Distill Fixes Applied Tonight

- `DATABASE_URL` set in Vercel (correct `aws-1` pooler host, not `aws-0`)
- Navbar: try/catch guard + 3s `Promise.race` timeout (no more hangs/500s)
- Lazy DB/Stripe init (missing env vars don't crash)
- 65/65 E2E passing, 0 skipped
- **Status: qa [qa-feedback]** — ready for operator walkthrough at https://distill-weld.vercel.app
- Test account: `test@distill.app` / `TestDistill2026!`
- Tier change dispatched: Pro = 10/day (was 50/day)

## SentinelHire Post-Login Redesign Dispatched

- Operator feedback: homepage great, everything beyond looks generic/basic
- Dispatched to SH PL: Sally redesigns dashboard, campaign creation, campaign detail, assessment flow, results
- Sally must use frontend-design + motion skills, both mobile + desktop mockups
- **Status: qa [greenfield]** — https://sentinel-hire.vercel.app (redesign in flight)
- Test account: `kelly+sentinelhire@bloomtech.com` / `SentinelTest2026!`

## Masterpiece Remix Status

- Blocked on GoDaddy DNS apex A record → operator chose to test against Vercel URL instead
- 41 skipped tests (Stripe/R2/ShipStation) — removed per no-skip rule (deferred, not skipped)
- E2E rerunning against `homageart-r2zcmbm8n-kelly-1224s-projects.vercel.app`
- **Status: testing [greenfield]**

## ReelRolla Desktop Redesign

- Operator requested: built mostly for mobile, needs desktop designs
- Queued: Sally → Bob → Amelia (UX change depth)
- **Status: qa [greenfield]** — https://reelrolla.vercel.app
- Desktop redesign NOT yet kicked off — waiting on operator go-ahead

## Factory Architecture Changes This Session

### Lifecycle Field Added
- New field `lifecycle` in project-state.json: `greenfield | qa-feedback | hotfix | feature`
- `phase` = where in pipeline (plan/build/testing/qa/shipped)
- `lifecycle` = what kind of work it is
- All 4 active projects seeded with correct values
- Dashboard updated: both badges on project cards + detail header
- PL flow updated: set phase=build + lifecycle=qa-feedback on FIX path entry
- Quick Update template updated: time since last activity + one-line status/blocker

### `pending-qa` → `qa` rename
- Simpler. Updated everywhere: docs, project-state files, cron, dashboard, API routes

### Quick Update Template
- Now shows: `name — phase [lifecycle] emoji · time · status/URL`

### Animation Standards
- frontend-design skill: animations where they add to design (not blanket mandatory)
- Sally AGENTS.md: must read motion skill + write Animation & Motion section in UX spec
- Amelia AGENTS.md: must read frontend-design + motion + responsive-design skills for UI stories
- Mobile animation rules: transform/opacity only, shorter durations, prefers-reduced-motion

### Stripe Skill Overhaul
- One account (`kelly@bloomtech.com`), per-project products with metadata
- Product naming: `"Distill — Pro"`, `"ReelRolla — Pro"` etc.
- `metadata[project]`, `metadata[tier]`, `metadata[daily_limit]` on every product
- Full webhook handler with idempotency, all 5 key events
- Webhook registration via CLI
- DB schema for Stripe state + webhook events table
- `docs/core/factory-accounts.md` git-ignored (was tracked, now removed from git)

### Supabase Skill
- Added warning: `DATABASE_URL` pooler host (`aws-0` vs `aws-1`) is NOT predictable — always retrieve from dashboard/API, never construct manually

---

## Project States (03:29 CST)

| Project | Phase | Lifecycle | URL | Notes |
|---|---|---|---|---|
| Distill | qa | qa-feedback | https://distill-weld.vercel.app | 65/65, ready for QA. Tier fix (10/day) dispatched. |
| SentinelHire | qa | greenfield | https://sentinel-hire.vercel.app | Redesign in flight (Sally running) |
| ReelRolla | qa | greenfield | https://reelrolla.vercel.app | Desktop redesign queued (not started) |
| Masterpiece | testing | greenfield | https://homageart-r2zcmbm8n-kelly-1224s-projects.vercel.app | E2E rerunning |

## PL Sessions
- `agent:project-lead:project-distill`
- `agent:project-lead:project-reelrolla`
- `agent:project-lead:masterpiece-remix`
- `agent:project-lead:sentinel-hire`

## Waiting On Matt
- QA walkthrough: Distill (https://distill-weld.vercel.app)
- QA walkthrough: SentinelHire (https://sentinel-hire.vercel.app) — after redesign lands
- Go-ahead for ReelRolla desktop redesign (Sally → Bob → Amelia)
- Distill Stripe account separation (currently on shared kelly@bloomtech.com account — fine for now)

## Key Decisions
- One Stripe account for all factory projects, per-project products with metadata
- `factory-accounts.md` git-ignored
- `lifecycle` (not `mode`) for the high-level track field
- `qa` (not `pending-qa`) for the phase value
- Animations: add where they improve the design, not blanket mandatory
- No-skip rule: `test.skip` banned except story-AC documented rationale with explicit reason
- Supabase pooler host must be retrieved from dashboard, never hardcoded (`aws-0` vs `aws-1` varies by project)
