# Memory - 2026-02-20

## Sentinel Hire CSP Bug (Production)

- **Bug:** Firebase Auth blocked by CSP — `script-src` missing `https://apis.google.com`
- **Root cause in firebase.json CSP:** only `'self' 'unsafe-inline'` allowed for scripts
- **Also:** `Cross-Origin-Opener-Policy: same-origin` will break Google popup flows (needs `same-origin-allow-popups`), and `frame-src` needs `accounts.google.com`
- **Dispatched to PL (sentinel-hire):** Fix all three CSP issues + redeploy

## E2E Testing Policy Change (Factory-Wide)

- **Decision:** E2E tests must run against the real deployed app with real credentials — no mocking Firebase Auth or any external service
- **Root cause of sentinel-hire miss:** Playwright mocked `signInWithPopup`, so the real Google OAuth flow (which loads apis.google.com) never executed and the CSP violation was never seen
- **Changes made:**
  - `docs/core/project-lead-flow.md` v4.9 — added "E2E Testing Standards" block in Phase 3
  - `skills/factory/test/murat-testing/SKILL.md` — added same standards block at top
  - `docs/changelog/CHANGELOG.md` — entry added
- **Key rules:** real deployed URL (not localhost), real auth, console error listener = CSP auto-fail, dedicated test Gmail

## ⚠️ ACTION NEEDED: Dedicated Factory Test Gmail

- Need a dedicated Google account for E2E test auth flows
- **Do NOT use:** `kelly@bloomtech.com` (security risk in CI secrets)
- **Create:** e.g. `kellyfactory.test@gmail.com` or similar
- Store password in CI secrets as `TEST_ACCOUNT_PASSWORD`
- All future projects needing auth E2E will use this account
- Ask Austen to create this Gmail and share credentials

## 10:00-11:02 CST - SentinelHire QA + Factory Skills Overhaul

### SentinelHire QA Fixes (dispatched to PL, all live)
- **Access denied on login:** matt@mopacsoftware.com had no role claim — set to `admin` via Admin SDK script (`functions/set-role-temp.mjs`, now deleted)
- **Firestore never initialized:** Created DB via `gcloud firestore databases create`, deployed rules + indexes
- **Firestore rules bug:** `isEmployer()` excluded admins. Fixed: updated function to return true for both `employer` and `admin` roles. Deployed.
- **Mobile blocker:** Removed full-screen block + QR code. Now a soft advisory banner only. `qrcode.react` uninstalled. Live ✅
- **Double banner:** `DesktopRequired` was rendering in 3 places (main.tsx, DashboardLayout, CandidateLayout). Consolidated to root only. Live ✅
- **Button contrast (round 1):** Added `--border-button` token. Live ✅
- **Button contrast (round 2):** Icon buttons used `--text-muted` at rest (invisible). Bumped to `--text-secondary` app-wide. Live ✅
- **Assessment link broken:** Hardcoded `sentinelhire.app` domain everywhere. Replaced with `window.location.origin`. Live ✅
- **Campaign creation permissions error:** Firestore rules fix (isEmployer now includes admin). Live ✅
- **Cloud Functions not deployed:** Project on Spark plan — Firebase Gen 2 requires Blaze. Austen needs to upgrade at https://console.firebase.google.com/project/sentinel-hire-prod/usage/details
- **`sentinelhire.app` domain:** Not configured — app lives at `sentinel-hire-prod.web.app`

### Factory Skills Overhaul (10:30-11:02 CST)

#### New skills installed from ClaWHub (all audited, SAFE):
- `skills/nextjs-expert` — 766 lines, App Router comprehensive (jgarrison929)
- `skills/shadcn-ui` — 634 lines, components + forms + theming (jgarrison929)
- `skills/vercel` — 288 lines, CLI reference (TheSethRose)
- `skills/drizzle` — 36 lines, tight gotcha guide (ivangdavila)
- `skills/lb-supabase-skill` — pending install (rate limited) — full Supabase docs
- `skills/responsive-design` — pending install (rate limited) — mobile-first patterns
- `skills/accessibility` — pending install — WCAG/a11y (score 1.208, highest found)
- `skills/lb-motion-skill` — pending install — Motion.dev animation docs

#### Rejected from ClaWHub:
- `stripe-api` (byungkyu) — routes through third-party "Maton API key" — RED FLAG

#### Skills to build from scratch (no good ClaWHub option):
- `supabase` — standalone setup/CLI skill (lb-supabase-skill covers docs but need factory-specific setup patterns)
- `neon` — serverless Postgres setup
- `stripe` — own it, don't trust third-party routing
- `redis` — caching/sessions add-on
- `vite-react` — SPA pattern

#### Security gate wired in:
- `skills/skill-security-audit/` — surfaced from factory/kelly-improver to top-level
- Added ClaWHub pre-install gate (inspect → read → audit → install)
- `AGENTS.md` — mandatory security audit rule added
- `TOOLS.md` — mandatory pre-install gate documented
- `skill-creator/SKILL.md` — Step 6 = security audit before delivery
- `workspace-kelly-improver/AGENTS.md` — security gate added with announce requirement

#### Winston default stack locked:
- Added "Preferred Tech Stack" section to `workspace-bmad-bmm-winston/AGENTS.md`
- Default: Next.js 15 + Neon + Drizzle + Vercel
- Firebase Gen 2 flagged as Blaze-required
- No mixing Firebase + Supabase in same project

#### frontend-design skill updated:
- Added "Interactive Element Standards" section (non-negotiable)
- Contrast minimums (4.5:1 text, 3:1 UI)
- Icon/ghost button resting state rules
- `window.location.origin` rule (no hardcoded domains)

### ⏳ Waiting On
- Austen: upgrade sentinel-hire-prod to Firebase Blaze plan (Cloud Functions blocked)
  → URL: https://console.firebase.google.com/project/sentinel-hire-prod/usage/details
  → After upgrade: `cd /Users/austenallred/clawd/projects/sentinel-hire && firebase deploy --only functions --project sentinel-hire-prod`
- lb-supabase-skill (leonaaardob) — inspected, file manifest retrieved, NOT YET AUDITED/INSTALLED
- responsive-design (wpank) — inspected, file manifest retrieved, NOT YET AUDITED/INSTALLED
- accessibility skill — found on ClaWHub (score 1.208, highest), NOT YET AUDITED/INSTALLED
- lb-motion-skill — found on ClaWHub (Motion.dev animation), NOT YET AUDITED/INSTALLED
- Build from scratch: neon, stripe, redis, vite-react skills (no good ClaWHub options found)
- Dedicated factory test Gmail account (e.g. kellyfactory.test@gmail.com) — ask Austen to create it

### Remaining Sentinel-Hire QA Items
- Cannot test candidate assessment flow until Cloud Functions are deployed (Blaze required)
- CSP bug dispatched to PL: missing `https://apis.google.com` in script-src, COOP header wrong, frame-src missing accounts.google.com
- Verify `team-members` read rule works for admins after `isEmployer()` fix
- Full E2E: create campaign → generate invite link → complete assessment (blocked on functions)
- sentinelhire.app domain not configured — app lives at sentinel-hire-prod.web.app

## 10:00-10:12 CST - Session Routing Bug Fix + Dashboard Fix

### Bug 1: agent:main:main missing from dashboard
- **Root cause:** `buildSubAgentSessions()` required a lock file — main sessions only hold lock during active LLM turn (~5s), so they'd vanish between responses
- **Fix:** Added `buildMainSessions()` to sessions API — reads from sessions.json index (same as PL cards), shows all `agent:main:*` webchat channels permanently
- Lock file just toggles status dot: active vs idle
- Dashboard now shows: Kelly (webchat), Matrix DMs, Signal, etc. always visible

### Bug 2: PL announce-backs going to wrong session
- **Root cause:** User's webchat session was `agent:main:matrix:direct:@matt:austens-mac-mini.local` (542f9c44), not `agent:main:main` (f947fba7)
- Why: session was created when Matrix message was first relayed through webchat — baked Matrix context into origin, but lastChannel=webchat
- PL hardcoded `sessions_send(sessionKey="agent:main:main")` — announce-backs missed the user
- **Fix:** `skills/factory/bin/get-kelly-session` script — dynamic lookup:
  1. Checks `state/kelly.json` (explicit override)
  2. Falls back to most-recently-updated webchat session in sessions.json
  3. Final fallback: agent:main:main
- `state/kelly.json` seeded with current active session key
- PL AGENTS.md: all 4 hardcoded `agent:main:main` replaced with `$(python3 ~/clawd/skills/factory/bin/get-kelly-session)`
- Sentinel-hire PL notified + acknowledged

### SentinelHire Status (10:12 CST)
- 70 stories shipped, 5 QA fixes landed (mobile blocker, double banner, button contrast x3)
- Holding for next round of user QA feedback
- Live at: https://sentinel-hire-prod.web.app

## SentinelHire - Post-Testing Todo
- Add rpetersen@gmail.com as employer role once SentinelHire is tested and ready

---

## 13:00-15:18 CST — New Project + Factory Overhaul Session

### New Project: Distill (Chrome Extension)
- **Concept:** Highlight text anywhere on web → AI summarizes to 1-2 sentences
- **Tiers:** Free (1/day hard wall) | $5/mo (50/day) | $10/mo (unlimited)
- **Stack:** Chrome Extension MV3 + Supabase + Stripe + GPT-4o-mini + Vercel
- **Input cap:** 10k chars, output toggle (Short/Medium/Detailed)
- **Status:** In implementation — 41/47 stories done as of 14:34 CST, 5 Amelias running in parallel
- **PL session:** agent:project-lead:project-distill

### Registry Cleanup
- **Deleted (hard):** fleai-market-v4, fleai-market-v5, takeouttrap, notelite, sentinel-hire (restored)
- **Active projects:** distill, reelrolla, masterpiece-remix, sentinel-hire
- **Folder trashed + removed from registry**

### SentinelHire Restored from Trash
- Used `mv ~/.Trash/sentinel-hire /Users/austenallred/clawd/projects/sentinel-hire`
- Git init + committed
- Re-added to registry (phase: qa)

### SentinelHire — Full Supabase Migration (correct course)
- **Decision:** Drop Firebase entirely (Auth + Firestore + Cloud Functions)
- **Replace with:** Supabase Auth + Postgres + Edge Functions + Vercel
- **Why:** Nothing deployed, zero users, clean slate — no JWT bridging hacks
- **Winston:** Rewrote full architecture (3,154 lines), all Firebase removed
- **John:** 34 migration stories across 6 epics (Epic 11→16, ~70h estimated)
- **Gate check:** FAIL first pass (3 blockers caught: role assignment gap, httpsCallable migration missing, CI/CD stories in wrong phase) → all fixed → PASS
- **Status as of 14:28:** Amelia implementing, Story 11.1 live (Firebase removal foundation)
- **Post-testing todo:** Add rpetersen@gmail.com as employer role

### Git Architecture Fix
- **Problem:** Projects were bleeding into clawd's git history
- **Solution:** Added `projects/*/` to `.gitignore`, `git rm -r --cached projects/`, pushed to remote
- **Each project now has its own git repo** (`git init` on creation)
- **On ship:** `gh repo create austenallred/{id} --private --source=. --push`
- **Docs updated:** AGENTS.md (Project Git Convention section), project-lead-flow.md (Phase 0: Git Init)

### Factory Workflow Improvements (committed to dev branch)

#### Unified Change Flow
- **Old:** Separate QA feedback flow, brownfield flow, correct course flow — all different
- **New:** One change flow, same pipeline at different depths
- **Order (fixed, never changes):** John → Sally → Winston → Bob → Amelia
- **Skip who isn't needed. Never reorder.**
- **Depths:** Bug only (Amelia) | Small (Bob→Amelia) | UX change (John→Sally→Bob→Amelia) | Arch change (John→Winston→Bob→Amelia) | Full (all)
- **Updated:** project-lead-flow.md, project-lead/AGENTS.md, john/winston/amelia AGENTS.md

#### Tech-Stack-Aware Pre-Deploy Gates
- **Old:** Hardcoded `tsc` + `eslint` (TS only)
- **New:** Read architecture.md first, adapt commands to actual stack (TS/Python/Chrome Extension/etc.)
- **Added:** Gate 3 (unit tests if they exist), Gate 4 (security scanning)

#### Murat Exploratory Tests (MANDATORY)
- **Old:** Murat only tested story ACs
- **New:** Two mandatory suites written independent of ACs:
  1. Happy path journey — full user flow, creates own data, per user role
  2. Error path journey — 3-5 real failure scenarios
- **Both are hard blockers** — if either fails, kick back to Amelia, don't enter pending-QA
- **Updated:** project-lead-flow.md, murat/AGENTS.md, project-lead/AGENTS.md

### Active Project Status (15:15 CST)
- **Distill:** Implementation, 41/47 done, 5 Amelias running
- **ReelRolla:** Phase 2 COMPLETE (46/46 stories) — awaiting Matt's go-ahead for Vercel deploy + Phase 3
- **Masterpiece Remix:** Planning, Bob writing 66 stories
- **SentinelHire:** Implementation, Story 11.1 in progress (Firebase removal)

### ⏳ Waiting On (as of 15:18)
- **Matt:** Go-ahead for ReelRolla Vercel deploy → Phase 3
- **rpetersen@gmail.com:** Add as employer on SentinelHire post-testing

---

## 15:18-16:20 CST — Factory Workflow + Skills Session

### Project Status (16:20 CST)
- **Distill:** QA phase — live at https://distill-ngwht9bb2-kelly-1224s-projects.vercel.app — 38/64 tests passed, 26 skipped (need TEST_USER_EMAIL + TEST_USER_PASSWORD). NFR fixes applied (timeout, CSS 96% reduction, aria-pressed). **Blocked: needs OPENAI_API_KEY in Vercel**
- **ReelRolla:** Testing phase — live at https://reelrolla.vercel.app — **Blocked: needs TMDB_API_KEY + WATCHMODE_API_KEY.** Auth bugs found (forgot password broken, localhost confirmation emails) — fixes dispatched to PL
- **Masterpiece Remix:** Implementation, 16/66 stories done, 5 Amelias running
- **SentinelHire:** Testing phase — 104/104 stories done (full Supabase migration). Awaiting Matt go-ahead for Phase 3

### ⏳ Waiting On Matt
- **OPENAI_API_KEY** for Distill → set in Vercel env vars
- **TMDB_API_KEY** for ReelRolla → https://www.themoviedb.org/settings/api
- **WATCHMODE_API_KEY** for ReelRolla → https://api.watchmode.com/
- **Go-ahead for SentinelHire Phase 3** (Vercel deploy + Murat testing)
- **rpetersen@gmail.com** → add as employer on SentinelHire post-testing

### Factory Workflow Changes (15:18-16:20)

#### Unified Change Flow (finalized)
- One pipeline for everything: QA feedback, brownfield, correct course, Phase 3 remediation
- Fixed order: John → Sally → Winston → Bob → Amelia (skip who isn't needed)
- Phase 3 Step 5 remediation = brownfield Change Flow explicitly
- Updated: project-lead-flow.md v5.0-5.5, PL/John/Winston/Amelia AGENTS.md

#### Phase 3 Testing Overhaul
- Split 3a/3b into Step 3 (test-gen, one-time) + Step 4 (execution+NFR, repeating) + Step 5 (remediation via Change Flow)
- Murat now writes mandatory happy path + error path journeys (exploratory, independent of ACs)
- Both journeys = hard blockers. Fail = kick to Amelia, no QA
- Pre-deploy gates now tech-stack-aware (reads architecture.md)
- Updated: project-lead-flow.md, PL/Murat AGENTS.md

#### Dual Viewport Designs (Sally)
- Sally now screenshots every screen at mobile (390px) AND desktop (1440px)
- design-assets.json uses -mobile/-desktop suffixes
- design-workflow.md updated with new schema
- frontend-design skill updated with naming convention
- Dashboard feature requested: Desktop Designs section (top) + Mobile Designs (below)
- Exception for fixed-viewport projects (Chrome extensions) → mobile-only

#### Supabase Skill Improvements
- CLI-first rule added at top (Management API → web-browser skill fallback)
- Project creation via Management API documented
- Auth enable (email + Google) via API documented
- Site URL config via API documented
- Auth email gotchas added: forgot password flow, localhost confirmation links
- Default auth = Google OAuth + email/password for ALL factory projects
- Google Cloud Console OAuth setup steps included

#### Git Architecture
- projects/*/ added to clawd .gitignore
- git rm -r --cached projects/ → remote now clean
- Each project has own git repo (git init on creation)
- AGENTS.md + project-lead-flow.md Phase 0 updated
- On ship: gh repo create austenallred/{id} --private

#### kelly-dashboard Feature (queued)
- Split design section: Desktop Designs (top) + Mobile Designs (below)
- Uses -desktop/-mobile key suffixes from design-assets.json
- Routed to kelly-dashboard PL
