#!/bin/bash
set -euo pipefail

# Provision a new Firebase backend (CLI-first).
# Usage:
#   firebase-provision <project_id> <project_name> <web_app_name>
#
# Notes:
# - Does NOT handle Google OAuth client creation (no public API).
# - Writes a .env.firebase fragment to projects/<project_id>/.env.firebase (or ./projects/<project_id> if present).

PROJECT_ID=${1:-}
PROJECT_NAME=${2:-}
WEB_APP_NAME=${3:-}

if [ -z "$PROJECT_ID" ] || [ -z "$PROJECT_NAME" ] || [ -z "$WEB_APP_NAME" ]; then
  echo "Usage: firebase-provision <project_id> <project_name> <web_app_name>" >&2
  exit 1
fi

command -v gcloud >/dev/null 2>&1 || { echo "Missing gcloud" >&2; exit 2; }
command -v firebase >/dev/null 2>&1 || { echo "Missing firebase" >&2; exit 2; }
command -v jq >/dev/null 2>&1 || { echo "Missing jq" >&2; exit 2; }

set +e
# Create project (idempotent-ish; if exists, continue)
gcloud projects describe "$PROJECT_ID" >/dev/null 2>&1
EXISTS=$?
set -e
if [ $EXISTS -ne 0 ]; then
  echo "Creating GCP project $PROJECT_ID ($PROJECT_NAME)"
  gcloud projects create "$PROJECT_ID" --name="$PROJECT_NAME"
else
  echo "GCP project exists: $PROJECT_ID"
fi

echo "Adding Firebase to project"
firebase projects:addfirebase "$PROJECT_ID" || true

echo "Enabling common APIs"
gcloud services enable \
  firebase.googleapis.com \
  identitytoolkit.googleapis.com \
  firestore.googleapis.com \
  cloudresourcemanager.googleapis.com \
  --project "$PROJECT_ID" >/dev/null

echo "Creating Firebase Web App"
CREATE_JSON=$(firebase apps:create web "$WEB_APP_NAME" --project "$PROJECT_ID" --json)
APP_ID=$(echo "$CREATE_JSON" | jq -r '.result.appId')

echo "Fetching Web SDK config"
SDK_JSON=$(firebase apps:sdkconfig web "$APP_ID" --project "$PROJECT_ID" --json)

API_KEY=$(echo "$SDK_JSON" | jq -r '.result.sdkConfig.apiKey')
AUTH_DOMAIN=$(echo "$SDK_JSON" | jq -r '.result.sdkConfig.authDomain')
STORAGE_BUCKET=$(echo "$SDK_JSON" | jq -r '.result.sdkConfig.storageBucket')
MSG_SENDER=$(echo "$SDK_JSON" | jq -r '.result.sdkConfig.messagingSenderId')
APP_ID2=$(echo "$SDK_JSON" | jq -r '.result.sdkConfig.appId')

OUT_DIR="projects/$PROJECT_ID"
mkdir -p "$OUT_DIR"
OUT_FILE="$OUT_DIR/.env.firebase"

cat > "$OUT_FILE" <<EOF
# Generated by firebase-provision
# Project: $PROJECT_ID
# Web App: $WEB_APP_NAME

NEXT_PUBLIC_FIREBASE_API_KEY=$API_KEY
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=$AUTH_DOMAIN
NEXT_PUBLIC_FIREBASE_PROJECT_ID=$PROJECT_ID
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=$STORAGE_BUCKET
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=$MSG_SENDER
NEXT_PUBLIC_FIREBASE_APP_ID=$APP_ID2
EOF

echo "âœ… Wrote $OUT_FILE"
