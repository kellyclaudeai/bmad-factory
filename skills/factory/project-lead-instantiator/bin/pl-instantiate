#!/usr/bin/env node

/**
 * Project Lead Instantiator
 *
 * Creates/reuses a project-named standalone session key for a given project id,
 * optionally updates project-state.json,
 * and prints the openclaw commands to start/check-in.
 */

const fs = require('node:fs');
const path = require('node:path');

function parseArgs(argv) {
  const args = {};
  for (let i = 2; i < argv.length; i++) {
    const a = argv[i];
    if (!a.startsWith('--')) continue;
    const key = a.slice(2);
    const next = argv[i + 1];
    if (next && !next.startsWith('--')) {
      args[key] = next;
      i++;
    } else {
      args[key] = true;
    }
  }
  return args;
}

function nowIso() {
  return new Date().toISOString();
}

function ensureDir(p) {
  fs.mkdirSync(p, { recursive: true });
}

function loadJson(p, fallback) {
  try {
    return JSON.parse(fs.readFileSync(p, 'utf8'));
  } catch {
    return fallback;
  }
}

function saveJson(p, obj) {
  ensureDir(path.dirname(p));
  fs.writeFileSync(p, JSON.stringify(obj, null, 2) + '\n', 'utf8');
}

// Deterministic per-project session keys.

function toProjectSlug(projectId) {
  // Make sure it's a safe session segment.
  // Keep it deterministic and readable.
  return String(projectId)
    .trim()
    .toLowerCase()
    .replace(/[^a-z0-9-_]+/g, '-')
    .replace(/-+/g, '-')
    .replace(/^-|-$/g, '');
}

function buildSessionKey(projectId) {
  const slug = toProjectSlug(projectId);
  if (!slug) throw new Error('Invalid project id/slug');
  return `agent:project-lead:${slug}`;
}

// Virtual-peer fallback intentionally removed.

function main() {
  const args = parseArgs(process.argv);
  const projectId = args['project-id'] || args.projectId;
  const projectDir = args['project-dir'] || args.projectDir;
  const noProjectState = !!args['no-project-state'];

  if (!projectId) {
    console.error('Missing --project-id');
    process.exit(2);
  }

  const entry = {
    sessionKey: buildSessionKey(projectId),
    createdAt: nowIso(),
    status: 'active',
  };

  // Optionally update project-state.json
  if (projectDir && !noProjectState) {
    const psPath = path.join(projectDir, 'project-state.json');
    const ps = loadJson(psPath, null);
    if (ps && typeof ps === 'object') {
      ps.projectLead = ps.projectLead || {};
      // Session key is canonical; no virtualPeer.
      ps.projectLead.sessionKey = entry.sessionKey;
      ps.projectLead.updatedAt = nowIso();
      saveJson(psPath, ps);
    }
  }

  const kickoff = projectDir
    ? `Start project ${projectId}. Work only in ${projectDir}. Use Barry Fast Mode when needed.`
    : `Start project ${projectId}. Use Barry Fast Mode when needed.`;

  console.log('---');
  console.log(`Project: ${projectId}`);
  console.log(`Session key: ${entry.sessionKey}`);
  console.log('---');
  console.log('Create/start Project Lead session (preferred):');
  console.log(
    `openclaw tui --session ${JSON.stringify(entry.sessionKey)} --message ${JSON.stringify(kickoff)}`,
  );
  console.log('---');
  console.log('Check in via TUI:');
  console.log(`openclaw tui --session ${JSON.stringify(entry.sessionKey)}`);
  console.log('---');
}

main();
