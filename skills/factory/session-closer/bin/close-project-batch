#!/usr/bin/env bash
set -euo pipefail

# Parse arguments
AGENT="project-lead"
PROJECT_IDS=()
SESSION_KEYS=()

while [[ $# -gt 0 ]]; do
  case "$1" in
    --agent)
      AGENT="$2"
      shift 2
      ;;
    *)
      # Check if it's a session key or project ID
      if [[ "$1" == agent:* ]]; then
        SESSION_KEYS+=("$1")
      else
        PROJECT_IDS+=("$1")
      fi
      shift
      ;;
  esac
done

if [ ${#PROJECT_IDS[@]} -eq 0 ] && [ ${#SESSION_KEYS[@]} -eq 0 ]; then
  echo "Usage: close-project-batch [--agent <agent>] <projectId1|sessionKey1> [<projectId2|sessionKey2> ...]" >&2
  echo "" >&2
  echo "Examples:" >&2
  echo "  close-project-batch calculator-app daily-todo-tracker" >&2
  echo "  close-project-batch --agent main jason jason-dashupdate" >&2
  echo "  close-project-batch --agent main agent:main:matrix:channel:xyz" >&2
  exit 2
fi

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SESS_DIR="$HOME/.openclaw/agents/$AGENT/sessions"
INDEX_PATH="$SESS_DIR/sessions.json"

if [ ! -f "$INDEX_PATH" ]; then
  echo "ERROR: sessions.json not found at $INDEX_PATH" >&2
  exit 1
fi

TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_PATH="$SESS_DIR/sessions.json.bak-batch-$TIMESTAMP"

# Backup
cp "$INDEX_PATH" "$BACKUP_PATH"
echo "✅ Backed up sessions.json to $BACKUP_PATH"

# Load current index
CURRENT_JSON=$(cat "$INDEX_PATH")

# Build list of session keys to remove
KEYS_TO_REMOVE=()

# Process project IDs
for PROJECT_ID in "${PROJECT_IDS[@]}"; do
  # Try both canonical and legacy formats
  CANONICAL="agent:$AGENT:$PROJECT_ID"
  LEGACY="agent:$AGENT:project-$PROJECT_ID"
  
  # Check if either exists
  if echo "$CURRENT_JSON" | jq -e ".[\"$CANONICAL\"]" > /dev/null 2>&1; then
    KEYS_TO_REMOVE+=("$CANONICAL")
    echo "  - Found: $CANONICAL"
  elif echo "$CURRENT_JSON" | jq -e ".[\"$LEGACY\"]" > /dev/null 2>&1; then
    KEYS_TO_REMOVE+=("$LEGACY")
    echo "  - Found: $LEGACY"
  else
    echo "  ⚠️  Not found: $PROJECT_ID (tried $CANONICAL and $LEGACY)"
  fi
done

# Process explicit session keys
for KEY in "${SESSION_KEYS[@]}"; do
  if echo "$CURRENT_JSON" | jq -e ".[\"$KEY\"]" > /dev/null 2>&1; then
    KEYS_TO_REMOVE+=("$KEY")
    echo "  - Found: $KEY"
  else
    echo "  ⚠️  Not found: $KEY"
  fi
done

if [ ${#KEYS_TO_REMOVE[@]} -eq 0 ]; then
  echo "ERROR: No sessions found to close" >&2
  exit 1
fi

echo ""
echo "Closing ${#KEYS_TO_REMOVE[@]} session(s):"

# Remove keys from index and archive transcripts
UPDATED_JSON="$CURRENT_JSON"
for KEY in "${KEYS_TO_REMOVE[@]}"; do
  # Get session ID before removing
  SESSION_ID=$(echo "$CURRENT_JSON" | jq -r ".[\"$KEY\"].sessionId // empty")
  
  # Remove from JSON
  UPDATED_JSON=$(echo "$UPDATED_JSON" | jq "del(.[\"$KEY\"])")
  
  # Archive transcript if exists
  if [ -n "$SESSION_ID" ] && [ -f "$SESS_DIR/${SESSION_ID}.jsonl" ]; then
    TRANSCRIPT_ARCHIVE="$SESS_DIR/${SESSION_ID}.jsonl.deleted.$TIMESTAMP"
    mv "$SESS_DIR/${SESSION_ID}.jsonl" "$TRANSCRIPT_ARCHIVE"
    echo "  ✅ Closed: $KEY (transcript archived)"
  else
    echo "  ✅ Closed: $KEY (no transcript)"
  fi
done

# Write updated index
echo "$UPDATED_JSON" | jq '.' > "$INDEX_PATH"
echo ""
echo "✅ Updated sessions.json"

# Restart gateway once
echo ""
echo "Restarting gateway..."
openclaw gateway restart > /dev/null 2>&1 &

echo "✅ Done! Gateway restarting in background."
echo ""
echo "Remaining sessions:"
jq 'keys' "$INDEX_PATH"
