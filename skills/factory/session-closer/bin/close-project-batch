#!/usr/bin/env bash
set -euo pipefail

if [ $# -eq 0 ]; then
  echo "Usage: close-project-batch <projectId1> [<projectId2> ...]" >&2
  echo "" >&2
  echo "Examples:" >&2
  echo "  close-project-batch calculator-app daily-todo-tracker" >&2
  echo "  close-project-batch fleai-market-v5 hydration-tracker meeting-time-tracker" >&2
  exit 2
fi

BASE_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
SESS_DIR="$HOME/.openclaw/agents/project-lead/sessions"
INDEX_PATH="$SESS_DIR/sessions.json"

if [ ! -f "$INDEX_PATH" ]; then
  echo "ERROR: sessions.json not found at $INDEX_PATH" >&2
  exit 1
fi

TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_PATH="$SESS_DIR/sessions.json.bak-batch-$TIMESTAMP"

# Backup
cp "$INDEX_PATH" "$BACKUP_PATH"
echo "✅ Backed up sessions.json to $BACKUP_PATH"

# Load current index
CURRENT_JSON=$(cat "$INDEX_PATH")

# Build list of session keys to remove
KEYS_TO_REMOVE=()
for PROJECT_ID in "$@"; do
  # Try both canonical and legacy formats
  CANONICAL="agent:project-lead:$PROJECT_ID"
  LEGACY="agent:project-lead:project-$PROJECT_ID"
  
  # Check if either exists
  if echo "$CURRENT_JSON" | jq -e ".[\"$CANONICAL\"]" > /dev/null 2>&1; then
    KEYS_TO_REMOVE+=("$CANONICAL")
    echo "  - Found: $CANONICAL"
  elif echo "$CURRENT_JSON" | jq -e ".[\"$LEGACY\"]" > /dev/null 2>&1; then
    KEYS_TO_REMOVE+=("$LEGACY")
    echo "  - Found: $LEGACY"
  else
    echo "  ⚠️  Not found: $PROJECT_ID (tried $CANONICAL and $LEGACY)"
  fi
done

if [ ${#KEYS_TO_REMOVE[@]} -eq 0 ]; then
  echo "ERROR: No sessions found to close" >&2
  exit 1
fi

echo ""
echo "Closing ${#KEYS_TO_REMOVE[@]} session(s):"

# Remove keys from index and archive transcripts
UPDATED_JSON="$CURRENT_JSON"
for KEY in "${KEYS_TO_REMOVE[@]}"; do
  # Get session ID before removing
  SESSION_ID=$(echo "$CURRENT_JSON" | jq -r ".[\"$KEY\"].sessionId // empty")
  
  # Remove from JSON
  UPDATED_JSON=$(echo "$UPDATED_JSON" | jq "del(.[\"$KEY\"])")
  
  # Archive transcript if exists
  if [ -n "$SESSION_ID" ] && [ -f "$SESS_DIR/${SESSION_ID}.jsonl" ]; then
    TRANSCRIPT_ARCHIVE="$SESS_DIR/${SESSION_ID}.jsonl.deleted.$TIMESTAMP"
    mv "$SESS_DIR/${SESSION_ID}.jsonl" "$TRANSCRIPT_ARCHIVE"
    echo "  ✅ Closed: $KEY (transcript archived)"
  else
    echo "  ✅ Closed: $KEY (no transcript)"
  fi
done

# Write updated index
echo "$UPDATED_JSON" | jq '.' > "$INDEX_PATH"
echo ""
echo "✅ Updated sessions.json"

# Restart gateway once
echo ""
echo "Restarting gateway..."
openclaw gateway restart > /dev/null 2>&1 &

echo "✅ Done! Gateway restarting in background."
echo ""
echo "Remaining sessions:"
jq 'keys' "$INDEX_PATH"
